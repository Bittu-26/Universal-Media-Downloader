<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Media Downloader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            500: '#6366f1',
                            600: '#4f46e5',
                        },
                        dark: {
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    animation: {
                        'spin-slow': 'spin 1.5s linear infinite',
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        .platform-icon {
            transition: all 0.3s ease;
        }
        .platform-icon:hover {
            transform: scale(1.1);
        }
        .drag-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .drag-area.active {
            border-color: #6366f1;
            background-color: rgba(99, 102, 241, 0.05);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Progress bar animation */
        @keyframes progress-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .downloading {
            animation: progress-pulse 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-dark-900 min-h-screen transition-colors duration-300">
    <div class="container mx-auto px-4 py-8">
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 rounded-lg bg-primary-500 flex items-center justify-center">
                    <i class="fas fa-download text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Universal Media Downloader</h1>
            </div>
            <button id="theme-toggle" class="p-2 rounded-lg bg-gray-200 dark:bg-dark-800 text-gray-700 dark:text-gray-300">
                <i class="fas fa-moon dark:hidden"></i>
                <i class="fas fa-sun hidden dark:inline"></i>
            </button>
        </header>

        <main class="max-w-3xl mx-auto">
            <section class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-6 mb-8">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">Download Media from Any Platform</h2>
                    <p class="text-gray-600 dark:text-gray-300">Paste a link below to download videos, audio, or playlists from YouTube, Instagram, TikTok, and more.</p>
                </div>

                <div class="mb-6">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="media-url" 
                            placeholder="Paste video URL here (e.g., YouTube, Instagram, TikTok...)" 
                            class="w-full p-4 pr-12 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark-800 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:text-white"
                        >
                        <button id="paste-btn" class="absolute right-3 top-1/2 transform -translate-y-1/2 p-2 text-gray-500 hover:text-primary-500">
                            <i class="fas fa-paste"></i>
                        </button>
                    </div>
                    <div id="url-error" class="text-red-500 text-sm mt-1 hidden">Please enter a valid URL from a supported platform.</div>
                </div>

                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">Supported Platforms</h3>
                    <div class="flex flex-wrap gap-4 justify-center">
                        <div class="platform-icon w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center" title="YouTube">
                            <i class="fab fa-youtube text-red-600 text-xl"></i>
                        </div>
                        <div class="platform-icon w-12 h-12 rounded-full bg-pink-100 dark:bg-pink-900/30 flex items-center justify-center" title="Instagram">
                            <i class="fab fa-instagram text-pink-600 text-xl"></i>
                        </div>
                        <div class="platform-icon w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center" title="Facebook">
                            <i class="fab fa-facebook text-blue-600 text-xl"></i>
                        </div>
                        <div class="platform-icon w-12 h-12 rounded-full bg-black dark:bg-gray-700 flex items-center justify-center" title="TikTok">
                            <i class="fab fa-tiktok text-white text-xl"></i>
                        </div>
                        <div class="platform-icon w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center" title="Twitter/X">
                            <i class="fab fa-twitter text-blue-400 text-xl"></i>
                        </div>
                        <div class="platform-icon w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center" title="Vimeo">
                            <i class="fab fa-vimeo-v text-green-500 text-xl"></i>
                        </div>
                        <div class="platform-icon w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center" title="Terabox">
                            <i class="fas fa-box text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <button id="download-btn" class="w-full bg-primary-500 hover:bg-primary-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                    <span id="download-text">Download Now</span>
                    <span id="download-spinner" class="hidden ml-2">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                </button>
            </section>

            <section id="media-preview" class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-6 mb-8 hidden fade-in">
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="md:w-1/3">
                        <div class="bg-gray-100 dark:bg-dark-700 rounded-lg overflow-hidden aspect-video">
                            <img id="media-thumbnail" src="" alt="Video thumbnail" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <div class="md:w-2/3">
                        <h3 id="media-title" class="text-xl font-bold text-gray-800 dark:text-white mb-2"></h3>
                        <p id="media-author" class="text-gray-600 dark:text-gray-300 mb-4"></p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="format-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Format</label>
                                <select id="format-select" class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark-800 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:text-white">
                                    <option value="mp4">MP4 (Video)</option>
                                    <option value="mp3">MP3 (Audio)</option>
                                    <option value="webm">WebM</option>
                                </select>
                            </div>
                            <div>
                                <label for="quality-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Quality</label>
                                <select id="quality-select" class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark-800 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:text-white">
                                    </select>
                            </div>
                        </div>
                        
                        <button id="start-download-btn" class="w-full bg-primary-500 hover:bg-primary-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                            <span id="start-download-text">Start Download</span>
                            <span id="start-download-spinner" class="hidden ml-2">
                                <i class="fas fa-spinner fa-spin"></i>
                            </span>
                        </button>
                    </div>
                </div>
            </section>

            <section class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-6">
                <div class="flex items-start">
                    <div class="flex-shrink-0 pt-1">
                        <i class="fas fa-exclamation-circle text-yellow-500 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-yellow-800 dark:text-yellow-200">Copyright Notice</h3>
                        <div class="mt-2 text-sm text-yellow-700 dark:text-yellow-300">
                            <p>
                                This service is for personal use only. Downloading copyrighted content may violate terms of service of the respective platforms. 
                                Please respect copyright laws and only download content you have permission to use.
                            </p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="mt-12 text-center text-gray-600 dark:text-gray-400 text-sm">
            <p>Â© 2023 Universal Media Downloader. All rights reserved.</p>
            <p class="mt-1">Powered by <span class="font-semibold">Abyiut & Copilot</span></p>
        </footer>
    </div>

    <script>
// Theme Toggle
const themeToggle = document.getElementById('theme-toggle');
const html = document.documentElement;

themeToggle.addEventListener('click', () => {
    html.classList.toggle('dark');
    localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
});

// Check for saved theme preference
if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    html.classList.add('dark');
} else {
    html.classList.remove('dark');
}

// Paste from clipboard
const pasteBtn = document.getElementById('paste-btn');
const urlInput = document.getElementById('media-url');

pasteBtn.addEventListener('click', async () => {
    try {
        const text = await navigator.clipboard.readText();
        urlInput.value = text;
        urlInput.focus();
    } catch (err) {
        console.error('Failed to read clipboard contents: ', err);
    }
});

// Download Button Handler
const downloadBtn = document.getElementById('download-btn');
const downloadText = document.getElementById('download-text');
const downloadSpinner = document.getElementById('download-spinner');
const urlError = document.getElementById('url-error');
const mediaPreview = document.getElementById('media-preview');
const startDownloadBtn = document.getElementById('start-download-btn');
const startDownloadText = document.getElementById('start-download-text');
const startDownloadSpinner = document.getElementById('start-download-spinner');

// New element references for dynamic options
const formatSelect = document.getElementById('format-select');
const qualitySelect = document.getElementById('quality-select');

// Create progress bar elements
const progressBarContainer = document.createElement('div');
progressBarContainer.className = 'w-full bg-gray-200 dark:bg-dark-700 rounded-full h-2.5 mt-4 hidden';
const progressBar = document.createElement('div');
progressBar.className = 'bg-primary-500 h-2.5 rounded-full';
progressBar.style.width = '0%';
progressBarContainer.appendChild(progressBar);
mediaPreview.querySelector('.md\\:w-2\\/3').appendChild(progressBarContainer);

// --- Dynamic Quality Options Logic ---

let availableVideoQualities = []; 

const audioQualityOptions = [
    { value: '128', text: '128kbps (Standard)' },
    { value: '192', text: '192kbps (Good)' },
    { value: '256', text: '256kbps (High)' },
    { value: 'best', text: 'Best Available' }
];

formatSelect.addEventListener('change', () => {
    updateQualityOptions();
});

function updateQualityOptions() {
    qualitySelect.innerHTML = '';
    const selectedFormat = formatSelect.value;
    
    if (selectedFormat === 'mp3') {
        audioQualityOptions.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option.value;
            opt.textContent = option.text;
            if (option.value === '192') opt.selected = true;
            qualitySelect.appendChild(opt);
        });
    } else {
        const qualitiesToUse = availableVideoQualities.length > 0 ? 
                                availableVideoQualities : 
                                [2160, 1440, 1080, 720, 480, 360].sort((a, b) => b - a);
        
        const uniqueQualities = [...new Set(qualitiesToUse)];

        uniqueQualities.forEach(height => {
            const option = document.createElement('option');
            option.value = height;
            option.textContent = `${height}p`;
            if (height === 720) option.selected = true; 
            qualitySelect.appendChild(option);
        });
        
        const bestOption = document.createElement('option');
        bestOption.value = 'best';
        bestOption.textContent = 'Best Available';
        qualitySelect.appendChild(bestOption);
    }
}

// --- End Dynamic Quality Options Logic ---


downloadBtn.addEventListener('click', async () => {
    const url = urlInput.value.trim();
    
    if (!url) {
        urlError.textContent = "Please enter a URL";
        urlError.classList.remove('hidden');
        return;
    }

    try {
        new URL(url);
    } catch (e) {
        urlError.textContent = "Please enter a valid URL";
        urlError.classList.remove('hidden');
        return;
    }

    downloadText.textContent = "Processing...";
    downloadSpinner.classList.remove('hidden');
    downloadBtn.disabled = true;
    urlError.classList.add('hidden');

    // Reset preview on new search
    mediaPreview.classList.add('hidden');
    progressBarContainer.classList.add('hidden');
    const progressTextElement = mediaPreview.querySelector('.text-sm.text-gray-600');
    if (progressTextElement) progressTextElement.remove();


    try {
        await showMediaPreview(url);
    } catch (error) {
        urlError.textContent = "An error occurred while processing the URL: " + error.message;
        urlError.classList.remove('hidden');
    } finally {
        downloadText.textContent = "Download Now";
        downloadSpinner.classList.add('hidden');
        downloadBtn.disabled = false;
    }
});

async function showMediaPreview(url) {
    const response = await fetch('/api/info', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: url }),
    });
    
    const data = await response.json();
    
    if (data.success) {
        document.getElementById('media-thumbnail').src = 
            data.info.thumbnail || 'https://via.placeholder.com/800x450';
        document.getElementById('media-title').textContent = 
            data.info.title || 'Media from ' + new URL(url).hostname;
        document.getElementById('media-author').textContent = 
            data.info.uploader || 'Unknown Author';
        
        // 1. Collect unique video qualities (heights)
        const heights = new Set();
        if (data.info.formats) {
            data.info.formats.forEach(format => {
                if (format.height && format.vcodec !== 'none') {
                    heights.add(format.height);
                }
            });
        }
        availableVideoQualities = Array.from(heights).sort((a, b) => b - a);

        // 2. Update quality options based on the default format selection (MP4)
        updateQualityOptions(); 
        
        mediaPreview.classList.remove('hidden');
        mediaPreview.scrollIntoView({ behavior: 'smooth' });
    } else {
        throw new Error(data.error || "Could not process URL");
    }
}

startDownloadBtn.addEventListener('click', async () => {
    const url = urlInput.value.trim();
    const format = document.getElementById('format-select').value;
    const quality = document.getElementById('quality-select').value;
    
    startDownloadText.textContent = "Preparing Download...";
    startDownloadSpinner.classList.remove('hidden');
    startDownloadBtn.disabled = true;
    
    progressBarContainer.classList.remove('hidden');
    progressBar.style.width = '0%';

    let progressText = mediaPreview.querySelector('.text-sm.text-gray-600');
    if (!progressText) {
        progressText = document.createElement('div');
        progressText.className = 'text-sm text-gray-600 dark:text-gray-300 mt-2';
        progressBarContainer.parentNode.insertBefore(progressText, progressBarContainer.nextSibling);
    }
    progressText.textContent = 'Connecting to server...';


    try {
        const eventSource = new EventSource(`/api/download-progress?url=${encodeURIComponent(url)}&format=${format}&quality=${quality}`);
        
        eventSource.onmessage = (event) => {
            const progress = JSON.parse(event.data);
            if (progress.status === 'downloading' || progress.status === 'processing') {
                const percent = progress.percent.replace('%', '');
                progressBar.style.width = `${percent}%`;
                startDownloadText.textContent = `${progress.status === 'downloading' ? 'Downloading' : 'Processing'}... ${percent}%`;
                if (progress.speed && progress.eta) {
                     progressText.textContent = `Speed: ${progress.speed} | ETA: ${progress.eta}`;
                } else if (progress.info) {
                     progressText.textContent = progress.info;
                } else {
                    progressText.textContent = `Status: ${progress.status}`;
                }
            } 
            else if (progress.status === 'finished') {
                eventSource.close();
                startDownloadText.textContent = "Finalizing...";
                progressText.textContent = "Server download complete. Initiating browser download...";
                triggerFinalDownload(url, format, quality, progressText);
            }
            else if (progress.status === 'error') {
                eventSource.close();
                progressText.textContent = `Error: ${progress.message}`;
            }
        };

        eventSource.onerror = (err) => {
            eventSource.close();
            console.error('EventSource error:', err);
            progressText.textContent = 'Error: Connection to download server failed or lost.';
            startDownloadSpinner.classList.add('hidden');
            startDownloadBtn.disabled = false;
            startDownloadText.textContent = "Start Download";
        };

    } catch (error) {
        progressBarContainer.classList.add('hidden');
        progressText.textContent = `Error: ${error.message}`;
        startDownloadSpinner.classList.add('hidden');
        startDownloadBtn.disabled = false;
        startDownloadText.textContent = "Start Download";
    }
});

async function triggerFinalDownload(url, format, quality, progressText) {
    try {
        const response = await fetch('/api/download', {
            method: 'POST',
            body: JSON.stringify({ url, format, quality }),
            headers: { 
                'Content-Type': 'application/json' 
            }
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Download failed');
        }
        
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        
        let filename = 'download.' + format;
        
        // --- FILENAME FIX: Use the Content-Disposition header for the correct filename ---
        const contentDisposition = response.headers.get('content-disposition');
        if (contentDisposition) {
            const matches = contentDisposition.match(/filename=(.+?)(;|$)/);
            if (matches && matches[1]) {
                let retrievedFilename = matches[1];
                retrievedFilename = retrievedFilename.replace(/^"|"$/g, '');
                
                try {
                    // This decodes the URL-encoded filename sent by the server
                    filename = decodeURIComponent(retrievedFilename);
                } catch (e) {
                    console.error("Failed to decode filename:", e);
                    filename = retrievedFilename; 
                }
            }
        }
        // --- END FILENAME FIX ---
        
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(downloadUrl);
        
        // Final success state
        progressBar.style.width = '100%';
        progressText.textContent = 'Download complete! File saved to your device.';
        startDownloadText.textContent = "Download Complete!";
        
        setTimeout(() => {
            progressBarContainer.classList.add('hidden');
            progressText.remove();
            startDownloadSpinner.classList.add('hidden');
            startDownloadBtn.disabled = false;
            startDownloadText.textContent = "Start Download";
        }, 5000);
        
    } catch (error) {
        progressBarContainer.classList.add('hidden');
        progressText.textContent = `Error during final download: ${error.message}`;
        startDownloadSpinner.classList.add('hidden');
        startDownloadBtn.disabled = false;
        startDownloadText.textContent = "Start Download";
    }
}

// Initial call to populate quality options (defaults to MP4 quality list)
document.addEventListener('DOMContentLoaded', updateQualityOptions);

    </script>
</body>
</html>